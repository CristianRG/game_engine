class t{constructor(){this.id=t._id++}}class e extends t{constructor(t=null){super(),this.strategy=t}execute(){this.strategy&&this.strategy.collide()}}class s extends t{constructor(t=!1,e=null){super(),this.setupAlready=t,this.strategy=e}execute(){this.setup()}setup(){this.setupAlready||(this.setupAlready=!0,document.addEventListener("keydown",(t=>{this.strategy&&this.strategy.trigger(t.key)})))}}class i extends t{constructor(t){super(),this.strategy=t}execute(){this.strategy.applyPhysics()}}class n extends t{constructor(t=null){super(),this.strategy=t}execute(){this.strategy&&this.strategy.render()}}class o{constructor(){this.scenes=[],this.entities=[],this.objects=[]}static getInstance(){return o.instance||(o.instance=new o),o.instance}}class r{constructor(){this._components=new Map}addComponent(t){return this._components.set(t.constructor.name,t),"setEntity"in t&&"function"==typeof t.setEntity&&t.setEntity(this),this}getComponent(t){return this._components.get(t.name)}hasComponent(t){return this._components.has(t.name)}}class c{setEntity(t){this.entity=t}}class h{setEntity(t){this.entity=t}}class a extends c{}class p extends a{constructor(t=0,e=0,s=50,i=50,n=5,o=0){super(),this.x=t,this.y=e,this.width=s,this.height=i,this.movementSpeed=n,this.rotation=o,this.movementTimeout=null,this.MOVEMENT_TIMEOUT_DURATION=100,this.direction="quiet"}translate(t){let e,s;switch(t){case"up":e=0,s=-this.movementSpeed;break;case"down":e=0,s=this.movementSpeed;break;case"left":e=-this.movementSpeed,s=0;break;case"right":e=this.movementSpeed,s=0;break;default:e=0,s=0}this.x+=e,this.y+=s,this.trackMovementDirection(e,s),this.resetMovementTimeout()}undo(){switch(this.direction){case"up":this.y+=this.movementSpeed;break;case"down":this.y-=this.movementSpeed;break;case"left":this.x+=this.movementSpeed;break;case"right":this.x-=this.movementSpeed}}trackMovementDirection(t,e){t<0&&(this.direction="left"),t>0&&(this.direction="right"),e<0&&(this.direction="up"),e>0&&(this.direction="down")}resetMovementTimeout(){null!==this.movementTimeout&&clearTimeout(this.movementTimeout),this.movementTimeout=setTimeout((()=>{this.direction="quiet"}),this.MOVEMENT_TIMEOUT_DURATION)}}let l=class t extends a{constructor(t=()=>{}){super(),this.onCollision=t}isColliding(e){const s=this.entity.getComponent(t),i=e.entity.getComponent(t);if(!s||!i)return!1;const n=this.entity.getComponent(p),o=e.entity.getComponent(p);if(!n||!o)return!1;const r=n.x<o.x+o.width&&n.x+n.width>o.x&&n.y<o.y+o.height&&n.y+n.height>o.y;return r&&(this.collisionEnter(e),e.collisionEnter(this)),r}collisionEnter(t){const e=this.entity.getComponent(p),s=t.entity.getComponent(p);if(e&&s){if("quiet"!==e.direction)switch(e.direction){case"up":e.y=s.y+s.height;break;case"down":e.y=s.y-e.height;break;case"left":e.x=s.x+s.width;break;case"right":e.x=s.x-e.width}this.onCollision(t)}}};class d{constructor(){this.globalState=o.getInstance(),this.entitiesColliderExecuting=!1,this.objectsColliderExecuting=!1}collide(){this.entityCollide(),this.objectCollide()}entityCollide(){const t=this.globalState.entities.filter((t=>t.getComponent(l)));for(const e of t){const s=e.getComponent(l);for(const i of t){if(e===i)continue;const t=i.getComponent(l);s.isColliding(t)}}}objectCollide(){const t=this.globalState.objects.filter((t=>t.getComponent(l)));for(const e of t){const t=e.getComponent(l);for(const e of this.globalState.entities){const s=e.getComponent(l);t.isColliding(s)&&t.onCollision(s)}}}}class u extends a{constructor(t=new Map){super(),this.hashEvents=t}trigger(t){var e;null===(e=this.hashEvents.get(t))||void 0===e||e.event()}}class m{constructor(){this.entities=o.getInstance().entities}trigger(t){const e=this.entities.filter((t=>t.getComponent(u)));for(const s of e){const e=s.getComponent(u);null==e||e.trigger(t)}}}let y=class extends a{constructor(t=[]){super(),this.physics=t}applyPhysics(){if(this.physics.length>0)for(const t of this.physics)t.entity||t.setEntity(this.entity),t.applyPhysics()}},g=class{constructor(){this.entities=o.getInstance().entities}applyPhysics(){const t=this.entities.filter((t=>t.getComponent(y)));for(const e of t){const t=e.getComponent(y);t&&t.applyPhysics()}}},f=class extends a{constructor(t=[],e=0,s=!1){super(),this.sprite=t,this.speed=e,this.loop=s,this.currentSpriteIndex=0}getCurrentSprite(){return this.sprite[this.currentSpriteIndex]}nextSprite(){this.currentSpriteIndex=this.currentSpriteIndex+1>=this.sprite.length?0:this.currentSpriteIndex+1}};class x{constructor(){this.stopped=!0,this.index=0}draw(t,e){for(const s of e){const{entity:e,x_offset:i,initialX:n,initialY:o,y_offset:r,frameWidth:c,frameHeight:h,resizeWidth:a,resizeHeight:l,currentFrame:d,image:u}=s.getCurrentSprite(),m=e.getComponent(p);if(!m)return;const{x:y,y:g}=m;t.drawImage(u,n+(d-1)*(c+i),o+r,c,h,y,g,a,l),s.loop||(s.loop=!0,setInterval((()=>{const t=s.getCurrentSprite();t.currentFrame=t.currentFrame+1>=t.frameCount?1:t.currentFrame+1}),s.speed))}}update(){}reset(){}play(t,e){this.stopped=!1,this.draw(t,e)}stop(){this.stopped=!0}}class C extends x{constructor(t,e){super(),this.sprites=[],this.ctx=null,this.stopped=!1,this.ctx=t}render(){if(this.stopped||!this.ctx)return;const t=o.getInstance().scenes[0];this.sprites=[...t.entities.filter((t=>t.hasComponent(f))).map((t=>t.getComponent(f))),...t.objects.filter((t=>t.hasComponent(f))).map((t=>t.getComponent(f)))],this.play(this.ctx,this.sprites)}}class v extends a{constructor(t="black"){super(),this.color=t}}class w{constructor(t){this.canvas=t.canvas,this.scene=t}render(){const t=this.canvas.getContext("2d");if(t){t.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.scene.entities,s=this.scene.objects;this.renderEntities(e,t),this.renderObjects(s,t)}}renderEntities(t,e){for(const s of t){const t=s.getComponent(p),i=s.getComponent(v);t&&i&&(e.fillStyle=(null==i?void 0:i.color)||"black",e.fillRect(t.x,t.y,t.width,t.height))}}renderObjects(t,e){for(const s of t){const t=s.getComponent(p),i=s.getComponent(v);t&&(e.fillStyle=(null==i?void 0:i.color)||"black",e.fillRect(t.x,t.y,t.width,t.height))}}}class b{constructor(t){this.renderStrategies=[],this.renderStrategies=t||[]}render(){for(const t of this.renderStrategies)t.render()}}class S{constructor(){this.systems=[]}static getInstance(){return S.instance||(S.instance=new S),S.instance}addSystem(t){return this.systems.push(t),this}execute(){this.systems.forEach((t=>t.execute()))}}function E(t,e,s,i){var n,o=arguments.length,r=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,i);else for(var c=t.length-1;c>=0;c--)(n=t[c])&&(r=(o<3?n(r):o>3?n(e,s,r):n(e,s))||r);return o>3&&r&&Object.defineProperty(e,s,r),r}function j(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}"function"==typeof SuppressedError&&SuppressedError;var T;let I=T=class{constructor(t,e=[],s=[]){this.id=T._id++,this.canvas=t,this.entities=e,this.objects=s}};I._id=0,I=T=E([class{static registerScene(t){const e=t,s=o.getInstance(),i=function(...t){const i=new e(...t);return s.scenes.push(i),i};return i.prototype=e.prototype,Object.assign(i,e),i}}.registerScene,j("design:paramtypes",[HTMLCanvasElement,Array,Array])],I);class k{constructor(t){this.isRunning=!1,this.lastTime=0,this.ecs=S.getInstance(),this.ecs.addSystem(new e(new d)),this.ecs.addSystem(new i(new g)),this.ecs.addSystem(new s(!1,new m)),this.ecs.addSystem(new n(new w(new I(t)))),this.ecs.addSystem(new n(new b([new C(t.getContext("2d"),[])])))}loop(t){this.isRunning&&(this.lastTime=t,this.ecs.execute(),requestAnimationFrame(this.loop.bind(this)))}start(){this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}stop(){this.isRunning=!1}}var _;let O=_=class extends r{constructor(){super(),this.id=_._id++}};O._id=0,O=_=E([class{static registerEntity(t){const e=o.getInstance(),s=t,i=function(...t){const i=new s(...t);return e.entities.push(i),i};return i.prototype=s.prototype,Object.assign(i,s),i}}.registerEntity,j("design:paramtypes",[])],O);var R;let M=R=class extends r{constructor(){super(),this.id=R._id++}};M._id=0,M=R=E([class{static registerObject(t){const e=t,s=function(...t){return new e(...t)};return s.prototype=e.prototype,Object.assign(s,e),s}}.registerObject,j("design:paramtypes",[])],M);class P{constructor(t,e,s,i,n,o,r,c,h,a,p,l,d){this.initialX=0,this.initialY=0,this.entity=t,this.image=e,this.frameWidth=s,this.frameHeight=i,this.resizeWidth=n,this.resizeHeight=o,this.frameCount=r,this.currentFrame=1,this.x=null!=c?c:0,this.y=null!=h?h:0,this.x_offset=null!=a?a:0,this.y_offset=null!=p?p:0,this.initialX=null!=l?l:0,this.initialY=null!=d?d:0}}class A extends h{constructor(){super(...arguments),this.apply=!0,this.type="physics"}}class F extends A{constructor(t){super(),this.type="gravity",this.gravity=9.8,this.scene=o.getInstance().scenes[0],this.stop=!1,this.gravity=null!=t?t:this.gravity}applyPhysics(){const t=this.entity.getComponent(p);if(t&&!this.stop){const e=this.checkPossibleCollision(t);e?e.getComponent(p).y==t.y+t.height?this.apply=!1:this.apply=!0:this.checkEmptySpace(t)&&(this.apply=!0)}t&&this.apply&&!this.stop&&t.translate("down")}checkPossibleCollision(t){const e=this.scene.entities.filter((t=>t.hasComponent(p)&&t.id!==this.entity.id)),s=this.scene.objects.filter((t=>t.hasComponent(p)&&t.id!==this.entity.id));e.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y)),s.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y));const i=e.find((e=>t.x<e.getComponent(p).x+e.getComponent(p).width&&t.x+t.width>e.getComponent(p).x&&t.y+t.height<=e.getComponent(p).y)),n=s.find((e=>t.x<e.getComponent(p).x+e.getComponent(p).width&&t.x+t.width>e.getComponent(p).x&&t.y+t.height<=e.getComponent(p).y));if(i||n)return i?n?i.getComponent(p).y<n.getComponent(p).y?i:n:i:n}checkEmptySpace(t){const e=this.scene.entities.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&e.id!==this.entity.id})),s=this.scene.objects.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&e.id!==this.entity.id}));return void 0===e&&void 0===s}}class H extends A{constructor(t){super(),this.type="jump",this.scene=o.getInstance().scenes[0],this.movementTimeout=null,this.apply=!1,this.stop=!0,this.jumpSpeed=10,this.jumpSpeed=null!=t?t:this.jumpSpeed}applyPhysics(){const t=this.entity.getComponent(p);if(!t||!this.apply)return;if(!this.checkIfHasGravity())return;const e=this.entity.getComponent(y).physics.find((t=>"gravity"===t.type));!e.stop&&this.isOnGround(t)&&(e.stop=!0,this.stop=!1,this.resetTimeout(this.jumpSpeed,e)),!this.stop&&this.checkIfCanJump(t)?t.translate("up"):(this.apply=!1,this.stop=!0,e.stop=!1)}checkIfHasGravity(){var t;const e=this.entity.getComponent(y);return null!==(t=null==e?void 0:e.physics.some((t=>"gravity"===t.type)))&&void 0!==t&&t}isOnGround(t){const e=this.scene.entities.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y+t.height===s.y&&e.id!==this.entity.id})),s=this.scene.objects.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y+t.height===s.y&&e.id!==this.entity.id}));return void 0!==e||void 0!==s}checkIfCanJump(t){const e=this.scene.entities.filter((t=>t.hasComponent(p)&&t.id!==this.entity.id)),s=this.scene.objects.filter((t=>t.hasComponent(p)&&t.id!==this.entity.id));e.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y)),s.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y));const i=e.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y===s.y+s.height})),n=s.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y<=s.y+s.height}));return void 0===i&&void 0===n}resetTimeout(t,e){this.movementTimeout&&clearTimeout(this.movementTimeout),this.movementTimeout=setTimeout((()=>{this.apply=!1,this.stop=!0,e.stop=!1}),Math.pow(t,3))}}export{l as Collider,a as Component,S as ECS,k as Engine,O as Entity,M as GameObject,o as GlobalState,F as Gravity,u as InputKeys,H as Jump,A as Physics,y as PhysicsComponent,v as Renderable,I as Scene,P as Sprite,x as SpriteAnimationController,f as SpriteComponent,t as System,p as Transform};
//# sourceMappingURL=index.js.map
