class t{constructor(){this.id=t._id++}}class e extends t{constructor(t=null){super(),this.strategy=t}execute(){this.strategy&&this.strategy.collide()}}class s extends t{constructor(t=!1,e=null){super(),this.setupAlready=t,this.strategy=e}execute(){this.setup()}setup(){this.setupAlready||(this.setupAlready=!0,document.addEventListener("keydown",(t=>{this.strategy&&this.strategy.trigger(t.key)})))}}class n extends t{constructor(t){super(),this.strategy=t}execute(){this.strategy.applyPhysics()}}class i extends t{constructor(t=null){super(),this.strategy=t}execute(){this.strategy&&this.strategy.render()}}class o{constructor(){this.currentScene=null,this.scenes=[],this.entities=[],this.objects=[]}static getInstance(){return o.instance||(o.instance=new o),o.instance}}var c=Object.freeze({__proto__:null,GlobalState:o});class r{constructor(){this._components=new Map}addComponent(t){return this._components.set(t.constructor.name,t),"setObject"in t&&"function"==typeof t.setObject&&t.setObject(this),this}getComponent(t){return this._components.get(t.name)}hasComponent(t){return this._components.has(t.name)}}class h{setObject(t){this.object=t}}class a extends h{}class p extends a{constructor(t=0,e=0,s=50,n=50,i=5,o=0){super(),this.x=t,this.y=e,this.width=s,this.height=n,this.movementSpeed=i,this.rotation=o,this.movementTimeout=null,this.MOVEMENT_TIMEOUT_DURATION=100,this.direction="quiet"}translate(t){let e,s;switch(t){case"up":e=0,s=-this.movementSpeed;break;case"down":e=0,s=this.movementSpeed;break;case"left":e=-this.movementSpeed,s=0;break;case"right":e=this.movementSpeed,s=0;break;default:e=0,s=0}this.x+=e,this.y+=s,this.trackMovementDirection(e,s),this.resetMovementTimeout()}undo(){switch(this.direction){case"up":this.y+=this.movementSpeed;break;case"down":this.y-=this.movementSpeed;break;case"left":this.x+=this.movementSpeed;break;case"right":this.x-=this.movementSpeed}}trackMovementDirection(t,e){t<0&&(this.direction="left"),t>0&&(this.direction="right"),e<0&&(this.direction="up"),e>0&&(this.direction="down")}resetMovementTimeout(){null!==this.movementTimeout&&clearTimeout(this.movementTimeout),this.movementTimeout=setTimeout((()=>{this.direction="quiet"}),this.MOVEMENT_TIMEOUT_DURATION)}}let l=class t extends a{constructor(t=()=>{}){super(),this.onCollision=t}isColliding(e){const s=this.object.getComponent(t),n=e.object.getComponent(t);if(!s||!n)return!1;const i=this.object.getComponent(p),o=e.object.getComponent(p);if(!i||!o)return!1;const c=i.x<o.x+o.width&&i.x+i.width>o.x&&i.y<o.y+o.height&&i.y+i.height>o.y;return c&&(this.collisionEnter(e),e.collisionEnter(this)),c}collisionEnter(t){const e=this.object.getComponent(p),s=t.object.getComponent(p);if(e&&s){if("quiet"!==e.direction)switch(e.direction){case"up":e.y=s.y+s.height;break;case"down":e.y=s.y-e.height;break;case"left":e.x=s.x+s.width;break;case"right":e.x=s.x-e.width}this.onCollision(t)}}};class d{constructor(){this.globalState=o.getInstance(),this.entitiesColliderExecuting=!1,this.objectsColliderExecuting=!1}collide(){this.entityCollide(),this.objectCollide()}entityCollide(){const t=this.globalState.entities.filter((t=>t.getComponent(l)));for(const e of t){const s=e.getComponent(l);for(const n of t){if(e===n)continue;const t=n.getComponent(l);s.isColliding(t)}}}objectCollide(){const t=this.globalState.objects.filter((t=>t.getComponent(l)));for(const e of t){const t=e.getComponent(l);for(const e of this.globalState.entities){const s=e.getComponent(l);t.isColliding(s)&&t.onCollision(s)}}}}class u extends a{constructor(t=new Map){super(),this.hashEvents=t}trigger(t){var e;null===(e=this.hashEvents.get(t))||void 0===e||e.event()}}class m{constructor(){this.entities=o.getInstance().entities}trigger(t){const e=this.entities.filter((t=>t.getComponent(u)));for(const s of e){const e=s.getComponent(u);null==e||e.trigger(t)}}}let g=class extends a{constructor(t=[]){super(),this.physics=t}applyPhysics(){if(this.physics.length>0)for(const t of this.physics)t.object||t.setObject(this.object),t.applyPhysics()}};class y extends a{constructor(){super(),this.entities=[]}setEntities(t){this.entities=t}getEntities(){return this.entities}getEntityById(t){return this.entities.find((e=>e.id===t))}addEntity(t){this.entities.push(t)}removeEntity(t){const e=this.entities.findIndex((e=>e.id===t.id));e>-1&&this.entities.splice(e,1)}}class f extends a{constructor(){super(),this.objects=[]}setObjects(t){this.objects=t}getObjects(){return this.objects}getObjectById(t){return this.objects.find((e=>e.id===t))}addObject(t){this.objects.push(t)}removeObject(t){const e=this.objects.findIndex((e=>e.id===t.id));e>-1&&this.objects.splice(e,1)}}let C=class{constructor(){this.entities=[],this.gameObjects=[]}applyPhysics(){const t=o.getInstance().currentScene;t.hasComponent(y)&&(this.entities=t.getComponent(y).getEntities().filter((t=>t.hasComponent(g)))),t.hasComponent(f)&&(this.gameObjects=t.getComponent(f).getObjects().filter((t=>t.hasComponent(g))));for(const t of this.entities){const e=t.getComponent(g);e&&e.applyPhysics()}for(const t of this.gameObjects){const e=t.getComponent(g);e&&e.applyPhysics()}}};class x extends a{constructor(t="black"){super(),this.color=t}}let b=class extends a{constructor(t=[],e=0,s=!1){super(),this.sprite=t,this.speed=e,this.loop=s,this.currentSpriteIndex=0}bindObject(t){t.setObject(this.object)}getCurrentSprite(){var t,e;return!(null===(t=this.sprite[this.currentSpriteIndex])||void 0===t?void 0:t.object)&&this.sprite.length>0&&this.bindObject(this.sprite[this.currentSpriteIndex]),null!==(e=this.sprite[this.currentSpriteIndex])&&void 0!==e?e:null}nextSprite(){this.currentSpriteIndex=this.currentSpriteIndex+1>=this.sprite.length?0:this.currentSpriteIndex+1}};class v{constructor(){this.stopped=!0,this.index=0}draw(t,e){for(const s of e){if(!s.getCurrentSprite())continue;const{x_offset:e,initialX:n,initialY:i,y_offset:o,frameWidth:c,frameHeight:r,resizeWidth:h,resizeHeight:a,currentFrame:l,image:d,object:u}=s.getCurrentSprite(),m=u.getComponent(p);if(!m)continue;const{x:g,y:y}=m;t.drawImage(d,n+(l-1)*(c+e),i+o,c,r,g,y,h,a);const f=s.getCurrentSprite();f.currentFrame=f.currentFrame+1>=f.frameCount?1:f.currentFrame+1}}update(){}reset(){}play(t,e){this.stopped=!1,this.draw(t,e)}stop(){this.stopped=!0}}class j extends v{constructor(){super(),this.scene=void 0,this.canvas=void 0}render(){this.scene=o.getInstance().currentScene,this.canvas=this.scene.canvas;const t=this.canvas.getContext("2d");t&&(t.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderScene(t),this.renderElements(t))}renderScene(t){var e;if(null===(e=this.scene)||void 0===e?void 0:e.hasComponent(p)){if(this.scene.hasComponent(x)){const e=this.scene.getComponent(p),s=this.scene.getComponent(x);t.fillStyle=s.color,t.fillRect(e.x,e.y,e.width,e.height)}if(this.scene.hasComponent(b)){const e=this.scene.getComponent(b);this.play(t,[e])}}}renderElements(t){var e,s;let n=[],i=[];(null===(e=this.scene)||void 0===e?void 0:e.hasComponent(y))&&(n=this.scene.getComponent(y).getEntities()),(null===(s=this.scene)||void 0===s?void 0:s.hasComponent(f))&&(i=this.scene.getComponent(f).getObjects());for(const e of n){if(e.hasComponent(p)&&e.hasComponent(x)){const s=e.getComponent(p),n=e.getComponent(x);t.fillStyle=n.color,t.fillRect(s.x,s.y,s.width,s.height)}if(e.hasComponent(b)){const s=e.getComponent(b);this.play(t,[s])}}for(const e of i){if(e.hasComponent(p)&&e.hasComponent(x)){const s=e.getComponent(p),n=e.getComponent(x);t.fillStyle=n.color,t.fillRect(s.x,s.y,s.width,s.height)}if(e.hasComponent(b)){const s=e.getComponent(b);this.play(t,[s])}}}}class S{constructor(t){this.renderStrategies=[],this.renderStrategies=t||[]}render(){for(const t of this.renderStrategies)t.render()}}class w{constructor(){this.systems=[]}static getInstance(){return w.instance||(w.instance=new w),w.instance}addSystem(t){return this.systems.push(t),this}execute(){this.systems.forEach((t=>t.execute()))}}function O(t,e,s,n){var i,o=arguments.length,c=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,s):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,s,n);else for(var r=t.length-1;r>=0;r--)(i=t[r])&&(c=(o<3?i(c):o>3?i(e,s,c):i(e,s))||c);return o>3&&c&&Object.defineProperty(e,s,c),c}function I(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}"function"==typeof SuppressedError&&SuppressedError;var E;let T=E=class extends r{constructor(t){super(),this.id=E._id++,this.canvas=t}};T._id=0,T=E=O([class{static registerScene(t){const e=t,s=function(...t){const s=new e(...t);return Promise.resolve().then((function(){return c})).then((({GlobalState:t})=>{const e=t.getInstance(),n=e.scenes.find((t=>t.id===s.id));if(n)return n;e.scenes.push(s)})),s};return s.prototype=e.prototype,Object.assign(s,e),s}}.registerScene,I("design:paramtypes",[HTMLCanvasElement])],T);class k{constructor(t){this.isRunning=!1,this.lastTime=0,this.ecs=w.getInstance();const c=new T(t);o.getInstance().scenes.push(c),o.getInstance().currentScene=c,this.ecs.addSystem(new e(new d)),this.ecs.addSystem(new n(new C)),this.ecs.addSystem(new s(!1,new m)),this.ecs.addSystem(new i(new S([new j])))}loop(t){this.isRunning&&(this.lastTime=t,this.ecs.execute(),requestAnimationFrame(this.loop.bind(this)))}start(){this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}stop(){this.isRunning=!1}}var _;let P=_=class extends r{constructor(){super(),this.id=_._id++}};P._id=0,P=_=O([class{static registerEntity(t){const e=t,s=function(...t){const s=new e(...t);return Promise.resolve().then((function(){return c})).then((({GlobalState:t})=>{const e=t.getInstance(),n=e.entities.find((t=>t.id===s.id));if(n)return n;e.entities.push(s)})),s};return s.prototype=e.prototype,Object.assign(s,e),s}}.registerEntity,I("design:paramtypes",[])],P);var R;let M=R=class extends r{constructor(){super(),this.id=R._id++}};M._id=0,M=R=O([class{static registerObject(t){const e=t,s=function(...t){const s=new e(...t);return Promise.resolve().then((function(){return c})).then((({GlobalState:t})=>{const e=t.getInstance(),n=e.objects.find((t=>t.id===s.id));if(n)return n;e.objects.push(s)})),s};return s.prototype=e.prototype,Object.assign(s,e),s}}.registerObject,I("design:paramtypes",[])],M);class G extends h{constructor(t,e,s,n,i,o,c,r,h,a,p,l){super(),this.image=new Image,this.initialX=0,this.initialY=0,this.imageSrc=t,this.frameWidth=e,this.frameHeight=s,this.resizeWidth=n,this.resizeHeight=i,this.frameCount=o,this.currentFrame=1,this.x=null!=c?c:0,this.y=null!=r?r:0,this.x_offset=null!=h?h:0,this.y_offset=null!=a?a:0,this.initialX=null!=p?p:0,this.initialY=null!=l?l:0,this.loadImage()}loadImage(){this.image.src=this.imageSrc,this.image.onload=()=>{this.image=this.image}}}class A extends h{constructor(){super(...arguments),this.apply=!0,this.type="physics"}}class F extends A{constructor(t){super(),this.type="gravity",this.gravity=9.8,this.scene=o.getInstance().currentScene,this.stop=!1,this.gravity=null!=t?t:this.gravity}applyPhysics(){const t=this.object.getComponent(p);if(t&&!this.stop){const e=this.checkPossibleCollision(t);e?e.getComponent(p).y==t.y+t.height?this.apply=!1:this.apply=!0:this.checkEmptySpace(t)&&(this.apply=!0)}t&&this.apply&&!this.stop&&t.translate("down")}checkPossibleCollision(t){let e=[],s=[];this.scene.hasComponent(y)&&(e=this.scene.getComponent(y).getEntities()),this.scene.hasComponent(f)&&(s=this.scene.getComponent(f).getObjects()),e.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y)),s.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y));const n=e.find((e=>t.x<e.getComponent(p).x+e.getComponent(p).width&&t.x+t.width>e.getComponent(p).x&&t.y+t.height<=e.getComponent(p).y)),i=s.find((e=>t.x<e.getComponent(p).x+e.getComponent(p).width&&t.x+t.width>e.getComponent(p).x&&t.y+t.height<=e.getComponent(p).y));if(n||i)return n?i?n.getComponent(p).y<i.getComponent(p).y?n:i:n:i}checkEmptySpace(t){let e=[],s=[];this.scene.hasComponent(y)&&(e=this.scene.getComponent(y).getEntities()),this.scene.hasComponent(f)&&(s=this.scene.getComponent(f).getObjects());const n=e.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&e.id!==this.object.id})),i=s.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&e.id!==this.object.id}));return void 0===n&&void 0===i}}class H extends A{constructor(t){super(),this.type="jump",this.scene=o.getInstance().currentScene,this.movementTimeout=null,this.apply=!1,this.stop=!0,this.jumpSpeed=10,this.jumpSpeed=null!=t?t:this.jumpSpeed}applyPhysics(){const t=this.object.getComponent(p);if(!t||!this.apply)return;if(!this.checkIfHasGravity())return;const e=this.object.getComponent(g).physics.find((t=>"gravity"===t.type));!e.stop&&this.isOnGround(t)&&(e.stop=!0,this.stop=!1,this.resetTimeout(this.jumpSpeed,e)),!this.stop&&this.checkIfCanJump(t)?t.translate("up"):(this.apply=!1,this.stop=!0,e.stop=!1)}checkIfHasGravity(){var t;const e=this.object.getComponent(g);return null!==(t=null==e?void 0:e.physics.some((t=>"gravity"===t.type)))&&void 0!==t&&t}isOnGround(t){let e,s;return this.scene.hasComponent(y)&&(e=this.scene.getComponent(y).getEntities().find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y+t.height===s.y&&e!==this.object}))),this.scene.hasComponent(f)&&(s=this.scene.getComponent(f).getObjects().find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y+t.height===s.y&&e!==this.object}))),void 0!==e||void 0!==s}checkIfCanJump(t){let e=[],s=[];this.scene.hasComponent(y)&&(e=this.scene.getComponent(y).getEntities()),this.scene.hasComponent(f)&&(s=this.scene.getComponent(f).getObjects()),e.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y)),s.sort(((t,e)=>t.getComponent(p).y-e.getComponent(p).y));const n=e.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y===s.y+s.height})),i=s.find((e=>{const s=e.getComponent(p);return t.x<s.x+s.width&&t.x+t.width>s.x&&t.y===s.y+s.height}));return void 0===n&&void 0===i}resetTimeout(t,e){this.movementTimeout&&clearTimeout(this.movementTimeout),this.movementTimeout=setTimeout((()=>{this.apply=!1,this.stop=!0,e.stop=!1}),Math.pow(t,3))}}export{l as Collider,a as Component,w as ECS,k as Engine,y as Entities,P as Entity,M as GameObject,f as GameObjects,o as GlobalState,F as Gravity,u as InputKeys,H as Jump,A as Physics,g as PhysicsComponent,x as Renderable,T as Scene,G as Sprite,v as SpriteAnimationController,b as SpriteComponent,t as System,p as Transform};
//# sourceMappingURL=index.min.js.map
