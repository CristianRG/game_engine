class x{constructor(){this.id=x._id++}}class U extends x{constructor(t=null){super(),this.strategy=t}execute(){this.strategy&&this.strategy.collide()}}class W extends x{constructor(t=!1,e=null){super(),this.setupAlready=t,this.strategy=e}execute(){this.setup()}setup(){this.setupAlready||(this.setupAlready=!0,document.addEventListener("keydown",t=>{this.strategy&&this.strategy.trigger(t.key)}))}}class B extends x{constructor(t){super(),this.strategy=t}execute(){this.strategy.applyPhysics()}}class J extends x{constructor(t=null){super(),this.strategy=t}execute(){this.strategy&&this.strategy.render()}}class p{constructor(){this.currentScene=null,this.scenes=[],this.entities=[],this.objects=[]}static getInstance(){return p.instance||(p.instance=new p),p.instance}}var R=Object.freeze({__proto__:null,GlobalState:p});class M{constructor(){this._components=new Map}addComponent(t){return this._components.set(t.constructor.name,t),"setObject"in t&&typeof t.setObject=="function"&&t.setObject(this),this}getComponent(t){return this._components.get(t.name)}hasComponent(t){return this._components.has(t.name)}}class G{setObject(t){this.object=t}}class m extends G{}class r extends m{constructor(t=0,e=0,s=50,c=50,n=5,i=0){super(),this.x=t,this.y=e,this.width=s,this.height=c,this.movementSpeed=n,this.rotation=i,this.movementTimeout=null,this.MOVEMENT_TIMEOUT_DURATION=100,this.direction="quiet"}translate(t){let e,s;switch(t){case"up":e=0,s=-this.movementSpeed;break;case"down":e=0,s=this.movementSpeed;break;case"left":e=-this.movementSpeed,s=0;break;case"right":e=this.movementSpeed,s=0;break;default:e=0,s=0;break}this.x+=e,this.y+=s,this.trackMovementDirection(e,s),this.resetMovementTimeout()}undo(){switch(this.direction){case"up":this.y+=this.movementSpeed;break;case"down":this.y-=this.movementSpeed;break;case"left":this.x+=this.movementSpeed;break;case"right":this.x-=this.movementSpeed;break}}trackMovementDirection(t,e){t<0&&(this.direction="left"),t>0&&(this.direction="right"),e<0&&(this.direction="up"),e>0&&(this.direction="down")}resetMovementTimeout(){this.movementTimeout!==null&&clearTimeout(this.movementTimeout),this.movementTimeout=setTimeout(()=>{this.direction="quiet"},this.MOVEMENT_TIMEOUT_DURATION)}}let g=class E extends m{constructor(t=()=>{}){super(),this.onCollision=t}isColliding(t){const e=this.object.getComponent(E),s=t.object.getComponent(E);if(!e||!s)return!1;const c=this.object.getComponent(r),n=t.object.getComponent(r);if(!c||!n)return!1;const i=c.x<n.x+n.width&&c.x+c.width>n.x&&c.y<n.y+n.height&&c.y+c.height>n.y;return i&&(this.collisionEnter(t),t.collisionEnter(this)),i}collisionEnter(t){const e=this.object.getComponent(r),s=t.object.getComponent(r);if(!(!e||!s)){if(e.direction!=="quiet")switch(e.direction){case"up":e.y=s.y+s.height;break;case"down":e.y=s.y-e.height;break;case"left":e.x=s.x+s.width;break;case"right":e.x=s.x-e.width;break}this.onCollision(t)}}};class L{constructor(){this.globalState=p.getInstance(),this.entitiesColliderExecuting=!1,this.objectsColliderExecuting=!1}collide(){this.entityCollide(),this.objectCollide()}entityCollide(){const t=this.globalState.entities.filter(e=>e.getComponent(g));for(const e of t){const s=e.getComponent(g);for(const c of t){if(e===c)continue;const n=c.getComponent(g);s.isColliding(n)}}}objectCollide(){const t=this.globalState.objects.filter(e=>e.getComponent(g));for(const e of t){const s=e.getComponent(g);for(const c of this.globalState.entities){const n=c.getComponent(g);s.isColliding(n)&&s.onCollision(n)}}}}class H extends m{constructor(t=new Map){super(),this.hashEvents=t}trigger(t){var e;(e=this.hashEvents.get(t))===null||e===void 0||e.event()}}class V{constructor(){this.entities=p.getInstance().entities}trigger(t){const e=this.entities.filter(s=>s.getComponent(H));for(const s of e){const c=s.getComponent(H);c==null||c.trigger(t)}}}let C=class extends m{constructor(t=[]){super(),this.physics=t}applyPhysics(){if(this.physics.length>0)for(const t of this.physics)t.object||t.setObject(this.object),t.applyPhysics()}};class l extends m{constructor(){super(),this.entities=[]}setEntities(t){this.entities=t}getEntities(){return this.entities}getEntityById(t){return this.entities.find(e=>e.id===t)}addEntity(t){this.entities.push(t)}removeEntity(t){const e=this.entities.findIndex(s=>s.id===t.id);e>-1&&this.entities.splice(e,1)}}class d extends m{constructor(){super(),this.objects=[]}setObjects(t){this.objects=t}getObjects(){return this.objects}getObjectById(t){return this.objects.find(e=>e.id===t)}addObject(t){this.objects.push(t)}removeObject(t){const e=this.objects.findIndex(s=>s.id===t.id);e>-1&&this.objects.splice(e,1)}}let X=class{constructor(){this.entities=[],this.gameObjects=[]}applyPhysics(){const t=p.getInstance().currentScene;t.hasComponent(l)&&(this.entities=t.getComponent(l).getEntities().filter(e=>e.hasComponent(C))),t.hasComponent(d)&&(this.gameObjects=t.getComponent(d).getObjects().filter(e=>e.hasComponent(C)));for(const e of this.entities){const s=e.getComponent(C);s&&s.applyPhysics()}for(const e of this.gameObjects){const s=e.getComponent(C);s&&s.applyPhysics()}}};class y extends m{constructor(t="black"){super(),this.color=t}}let f=class extends m{constructor(t=[],e=0,s=!1){super(),this.sprite=t,this.speed=e,this.loop=s,this.currentSpriteIndex=0}bindObject(t){t.setObject(this.object)}getCurrentSprite(){var t,e;return!(!((t=this.sprite[this.currentSpriteIndex])===null||t===void 0)&&t.object)&&this.sprite.length>0&&this.bindObject(this.sprite[this.currentSpriteIndex]),(e=this.sprite[this.currentSpriteIndex])!==null&&e!==void 0?e:null}nextSprite(){this.currentSpriteIndex=this.currentSpriteIndex+1>=this.sprite.length?0:this.currentSpriteIndex+1}};class Y{constructor(){this.stopped=!0,this.index=0}draw(t,e){for(const s of e){if(!s.getCurrentSprite())continue;const{x_offset:c,initialX:n,initialY:i,y_offset:o,frameWidth:a,frameHeight:u,resizeWidth:j,resizeHeight:v,currentFrame:S,image:z,object:$}=s.getCurrentSprite(),F=$.getComponent(r);if(!F)continue;const{x:K,y:N}=F;t.drawImage(z,n+(S-1)*(a+c),i+o,a,u,K,N,j,v);const w=s.getCurrentSprite();w.currentFrame=w.currentFrame+1>=w.frameCount?1:w.currentFrame+1}}update(){}reset(){}play(t,e){this.stopped=!1,this.draw(t,e)}stop(){this.stopped=!0}}class Q extends Y{constructor(){super(),this.scene=void 0,this.canvas=void 0}render(){this.scene=p.getInstance().currentScene,this.canvas=this.scene.canvas;const t=this.canvas.getContext("2d");t&&(t.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderScene(t),this.renderElements(t))}renderScene(t){var e;if(!((e=this.scene)===null||e===void 0)&&e.hasComponent(r)){if(this.scene.hasComponent(y)){const s=this.scene.getComponent(r),c=this.scene.getComponent(y);t.fillStyle=c.color,t.fillRect(s.x,s.y,s.width,s.height)}if(this.scene.hasComponent(f)){const s=this.scene.getComponent(f);this.play(t,[s])}}}renderElements(t){var e,s;let c=[],n=[];!((e=this.scene)===null||e===void 0)&&e.hasComponent(l)&&(c=this.scene.getComponent(l).getEntities()),!((s=this.scene)===null||s===void 0)&&s.hasComponent(d)&&(n=this.scene.getComponent(d).getObjects());for(const i of c){if(i.hasComponent(r)&&i.hasComponent(y)){const o=i.getComponent(r),a=i.getComponent(y);t.fillStyle=a.color,t.fillRect(o.x,o.y,o.width,o.height)}if(i.hasComponent(f)){const o=i.getComponent(f);this.play(t,[o])}}for(const i of n){if(i.hasComponent(r)&&i.hasComponent(y)){const o=i.getComponent(r),a=i.getComponent(y);t.fillStyle=a.color,t.fillRect(o.x,o.y,o.width,o.height)}if(i.hasComponent(f)){const o=i.getComponent(f);this.play(t,[o])}}}}class Z{constructor(t){this.renderStrategies=[],this.renderStrategies=t||[]}render(){for(const t of this.renderStrategies)t.render()}}class b{constructor(){this.systems=[]}static getInstance(){return b.instance||(b.instance=new b),b.instance}addSystem(t){return this.systems.push(t),this}execute(){this.systems.forEach(t=>t.execute())}}function D(h,t,e,s){var c=arguments.length,n=c<3?t:s===null?s=Object.getOwnPropertyDescriptor(t,e):s,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(h,t,e,s);else for(var o=h.length-1;o>=0;o--)(i=h[o])&&(n=(c<3?i(n):c>3?i(t,e,n):i(t,e))||n);return c>3&&n&&Object.defineProperty(t,e,n),n}function A(h,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(h,t)}class tt{static registerScene(t){const e=t,s=function(...c){const n=new e(...c);return Promise.resolve().then(function(){return R}).then(({GlobalState:i})=>{const o=i.getInstance(),a=o.scenes.find(u=>u.id===n.id);if(a)return a;o.scenes.push(n)}),n};return s.prototype=e.prototype,Object.assign(s,e),s}}var I;let O=I=class extends M{constructor(t){super(),this.id=I._id++,this.canvas=t}};O._id=0;O=I=D([tt.registerScene,A("design:paramtypes",[HTMLCanvasElement])],O);class rt{constructor(t){this.isRunning=!1,this.lastTime=0,this.ecs=b.getInstance();const e=new O(t);p.getInstance().scenes.push(e),p.getInstance().currentScene=e,this.ecs.addSystem(new U(new L)),this.ecs.addSystem(new B(new X)),this.ecs.addSystem(new W(!1,new V)),this.ecs.addSystem(new J(new Z([new Q])))}loop(t){!this.isRunning||(this.lastTime=t,this.ecs.execute(),requestAnimationFrame(this.loop.bind(this)))}start(){this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(this.loop.bind(this))}stop(){this.isRunning=!1}}class et{static registerEntity(t){const e=t,s=function(...c){const n=new e(...c);return Promise.resolve().then(function(){return R}).then(({GlobalState:i})=>{const o=i.getInstance(),a=o.entities.find(u=>u.id===n.id);if(a)return a;o.entities.push(n)}),n};return s.prototype=e.prototype,Object.assign(s,e),s}}var T;let k=T=class extends M{constructor(){super(),this.id=T._id++}};k._id=0;k=T=D([et.registerEntity,A("design:paramtypes",[])],k);class st{static registerObject(t){const e=t,s=function(...c){const n=new e(...c);return Promise.resolve().then(function(){return R}).then(({GlobalState:i})=>{const o=i.getInstance(),a=o.objects.find(u=>u.id===n.id);if(a)return a;o.objects.push(n)}),n};return s.prototype=e.prototype,Object.assign(s,e),s}}var P;let _=P=class extends M{constructor(){super(),this.id=P._id++}};_._id=0;_=P=D([st.registerObject,A("design:paramtypes",[])],_);class pt extends G{constructor(t,e,s,c,n,i,o,a,u,j,v,S){super(),this.image=new Image,this.initialX=0,this.initialY=0,this.imageSrc=t,this.frameWidth=e,this.frameHeight=s,this.resizeWidth=c,this.resizeHeight=n,this.frameCount=i,this.currentFrame=1,this.x=o!=null?o:0,this.y=a!=null?a:0,this.x_offset=u!=null?u:0,this.y_offset=j!=null?j:0,this.initialX=v!=null?v:0,this.initialY=S!=null?S:0,this.loadImage()}loadImage(){this.image.src=this.imageSrc,this.image.onload=()=>{this.image=this.image}}}class q extends G{constructor(){super(...arguments),this.apply=!0,this.type="physics"}}class lt extends q{constructor(t){super(),this.type="gravity",this.gravity=9.8,this.scene=p.getInstance().currentScene,this.stop=!1,this.gravity=t!=null?t:this.gravity}applyPhysics(){const t=this.object.getComponent(r);if(t&&!this.stop){const e=this.checkPossibleCollision(t);e?e.getComponent(r).y==t.y+t.height?this.apply=!1:this.apply=!0:this.checkEmptySpace(t)&&(this.apply=!0)}t&&this.apply&&!this.stop&&t.translate("down")}checkPossibleCollision(t){let e=[],s=[];this.scene.hasComponent(l)&&(e=this.scene.getComponent(l).getEntities()),this.scene.hasComponent(d)&&(s=this.scene.getComponent(d).getObjects()),e.sort((i,o)=>i.getComponent(r).y-o.getComponent(r).y),s.sort((i,o)=>i.getComponent(r).y-o.getComponent(r).y);const c=e.find(i=>t.x<i.getComponent(r).x+i.getComponent(r).width&&t.x+t.width>i.getComponent(r).x&&t.y+t.height<=i.getComponent(r).y),n=s.find(i=>t.x<i.getComponent(r).x+i.getComponent(r).width&&t.x+t.width>i.getComponent(r).x&&t.y+t.height<=i.getComponent(r).y);if(!(!c&&!n)){if(c){if(!n)return c}else return n;return c.getComponent(r).y<n.getComponent(r).y?c:n}}checkEmptySpace(t){let e=[],s=[];this.scene.hasComponent(l)&&(e=this.scene.getComponent(l).getEntities()),this.scene.hasComponent(d)&&(s=this.scene.getComponent(d).getObjects());const c=e.find(i=>{const o=i.getComponent(r);return t.x<o.x+o.width&&t.x+t.width>o.x&&i.id!==this.object.id}),n=s.find(i=>{const o=i.getComponent(r);return t.x<o.x+o.width&&t.x+t.width>o.x&&i.id!==this.object.id});return c===void 0&&n===void 0}}class dt extends q{constructor(t){super(),this.type="jump",this.scene=p.getInstance().currentScene,this.movementTimeout=null,this.apply=!1,this.stop=!0,this.jumpSpeed=10,this.jumpSpeed=t!=null?t:this.jumpSpeed}applyPhysics(){const t=this.object.getComponent(r);if(!t||!this.apply||!this.checkIfHasGravity())return;const s=this.object.getComponent(C).physics.find(c=>c.type==="gravity");!s.stop&&this.isOnGround(t)&&(s.stop=!0,this.stop=!1,this.resetTimeout(this.jumpSpeed,s)),!this.stop&&this.checkIfCanJump(t)?t.translate("up"):(this.apply=!1,this.stop=!0,s.stop=!1)}checkIfHasGravity(){var t;const e=this.object.getComponent(C);return(t=e==null?void 0:e.physics.some(s=>s.type==="gravity"))!==null&&t!==void 0?t:!1}isOnGround(t){let e,s;return this.scene.hasComponent(l)&&(e=this.scene.getComponent(l).getEntities().find(c=>{const n=c.getComponent(r);return t.x<n.x+n.width&&t.x+t.width>n.x&&t.y+t.height===n.y&&c!==this.object})),this.scene.hasComponent(d)&&(s=this.scene.getComponent(d).getObjects().find(c=>{const n=c.getComponent(r);return t.x<n.x+n.width&&t.x+t.width>n.x&&t.y+t.height===n.y&&c!==this.object})),e!==void 0||s!==void 0}checkIfCanJump(t){let e=[],s=[];this.scene.hasComponent(l)&&(e=this.scene.getComponent(l).getEntities()),this.scene.hasComponent(d)&&(s=this.scene.getComponent(d).getObjects()),e.sort((i,o)=>i.getComponent(r).y-o.getComponent(r).y),s.sort((i,o)=>i.getComponent(r).y-o.getComponent(r).y);const c=e.find(i=>{const o=i.getComponent(r);return t.x<o.x+o.width&&t.x+t.width>o.x&&t.y===o.y+o.height}),n=s.find(i=>{const o=i.getComponent(r);return t.x<o.x+o.width&&t.x+t.width>o.x&&t.y===o.y+o.height});return c===void 0&&n===void 0}resetTimeout(t,e){this.movementTimeout&&clearTimeout(this.movementTimeout),this.movementTimeout=setTimeout(()=>{this.apply=!1,this.stop=!0,e.stop=!1},Math.pow(t,3))}}export{g as Collider,m as Component,b as ECS,rt as Engine,l as Entities,k as Entity,_ as GameObject,d as GameObjects,p as GlobalState,lt as Gravity,H as InputKeys,dt as Jump,q as Physics,C as PhysicsComponent,y as Renderable,O as Scene,pt as Sprite,Y as SpriteAnimationController,f as SpriteComponent,x as System,r as Transform};
